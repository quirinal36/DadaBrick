<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="products_sql">
	<insert id="insert" parameterType="products" useGeneratedKeys="true" keyProperty="id">
		INSERT INTO products
		(
			menuId,
			name,
			orderNum,
			primaryId,
			size,
			packaging,
			delivery,
			representImage
		)
		values
		(
			${menuId},
			'${name}',
			(SELECT MAX(p.orderNum)+1 FROM products p where p.menuId = ${menuId}),
			'${primaryId}',
			'${size}',
			'${packaging}',
			'${delivery}',
			${representImage}
		)
	</insert>
	<update id="update" parameterType="products">
		UPDATE products
		<set>
			orderNum = ${orderNum},
			menuId = ${menuId},
			name = '${name}',
			primaryId = '${primaryId}',
			size = '${size}',
			packaging = '${packaging}',
			delivery = '${delivery}',
			representImage = ${representImage}
		</set>
		<where>
			id=${id}
		</where>
	</update>
	<select id="select" parameterType="products" resultType="products">
		SELECT 
			p.*,
			menu.name AS menuName
		FROM 
			products p LEFT JOIN menus menu ON (p.menuId = menu.id)
		<where>
			p.menuId = ${menuId}
			<if test="query != ''">
			and 
				(
				p.name like '%${query}%'
				or
				p.primaryId like '%${query}%'
				)
			</if>
		</where>
		order by p.orderNum desc
		LIMIT ${from}, ${pageSize}
	</select>
	
	<select id="count" parameterType="products" resultType="int">
		SELECT COUNT(*) FROM products
		<where>
			menuId = ${menuId}
		</where>
	</select>
	
	<select id="select_one" parameterType="products" resultType="products">
		SELECT 
			p.*,
			menu.name AS menuName,
			menu.parentId AS parentId
		FROM 
			products p LEFT JOIN menus menu ON (p.menuId = menu.id)
		<where>
			p.id = ${id}
		</where>
	</select>
	
	<delete id="delete" parameterType="products">
		DELETE FROM products
		<where>
			id = ${id}		
		</where>
	</delete>
</mapper>